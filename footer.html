</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/languages/javascript.min.js"></script>
<script>
    (() => {
        const protocol = location.protocol.replace('http', 'ws');

        async function setAddress() {
            document.getElementById('protocol').innerHTML = protocol;
            document.getElementById('host').innerHTML = location.host;
            // document.getElementById('port').innerHTML = (await fetch('/login').then(resp => resp.json())).port;
        }

        function checkWS() {
            const testHtml = document.getElementById('test');
            const timeout = setTimeout(() => {
                testHtml.innerHTML = 'Connection timeout';
            }, 30000);
            const socket = new WebSocket(protocol + '//' + location.host);
            socket.onopen = function () {
                socket.send(JSON.stringify({ to: 'SERVER', data: 'ping' }));
            }
            socket.onmessage = function (msg) {
                const message = JSON.parse(msg.data);
                clearTimeout(timeout);
                if (message.error) {
                    testHtml.innerHTML = 'Something wrong...';
                    console.warn(message.error);
                } else if (message.data && message.data.id) {
                    testHtml.innerHTML = 'Server works ok';
                    console.log('login success: ' + message.data.id);
                } else if (message.data) {
                    console.log('new message:', message.data);
                }
                socket.close();
            }
            socket.onerror = function (error) {
                console.warn(error);
                testHtml.innerHTML = 'Something wrong...';
                clearTimeout(timeout);
            }
        }

        document.addEventListener('DOMContentLoaded', (event) => {
            setAddress();
            checkWS();
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
        });
    })();
</script>
</body>

</html>